name: schedule_dbt_run

on:
schedule:
    # run at 7AM every single day
    # https://crontab.guru <-- for generating CRON expression
    - cron: "0 7 * * *"

env:
  DBT_PROFILES_DIR: ./
  DBT_POSTGRES_HOST: ${{ secrets.DBT_POSTGRES_HOST }}
  DBT_POSTGRES_PORT: ${{ secrets.DBT_POSTGRES_PORT }}
  DBT_POSTGRES_USER: ${{ secrets.DBT_POSTGRES_USER }}
  DBT_POSTGRES_PW: ${{ secrets.DBT_POSTGRES_PW }}

jobs:
   schedule_dbt_run:
       name: schedule_dbt_run
       runs-on: ubuntu-latest

       steps:
       - name: Checkout repository
         uses: actions/checkout@master

       - name: Set up Python
         uses: actions/setup-python@v2
         with:
           python-version: "3.8.16"

       - name: Install dependencies
         run: |
           pip install dbt-postgres
           dbt deps

       # dbt related commands here - run use --target prod/dev to run for specific environments
       - name: Run dbt models
           run: dbt run

       - name: Test dbt models
           run: dbt test